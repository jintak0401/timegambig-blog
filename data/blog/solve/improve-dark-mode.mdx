---
title: '다크모드 성능 개선'
date: '2023-03-18'
lastmod: '2023-04-01'
tags: ['성능-개선','블로그']
draft: false
series: 문제와 해결책
summary: 스크롤이 길 때 모드를 전환하면 버벅임이 발생하는 문제가 있었습니다. 이 문제를 어떻게 해결하였는지 소개합니다.
images: [https://i.imgur.com/1oUS5EL.png]
layout: PostLayout
---

## 글을 쓰게 된 계기

현재는 개선된 상태이지만 전에는 모바일처럼 사양이 좋지 않은 환경에서 다크모드, 라이트모드간 전환을 할 때 버벅임이 발생하였습니다. 어째서 버벅임이 발생하는지 파악하고 해결하는 과정을 소개하겠습니다.

## 왜 버벅이지?

헤더의 우측에 보면 모드 전환 버튼이 있습니다. 이 버튼으로 모드를 전환하면 배경색이 바로 바뀌는 것이 아닌 서서히 바뀐다는 것을 알 수 있습니다. 웬만한 페이지에서는 괜찮았지만, 제 블로그 포스트 중 분량이 긴 [몇 몇](https://timegambit.com/blog/digging/react-query/01) [포스트의](https://timegambit.com/blog/digging/react-query/02) [경우](http://timegambit.com/blog/digging/async-await/02), 모바일 환경에서 모드 전환시 버벅임이 발생하였습니다.

![테스트 환경](https://i.imgur.com/dRpjEB4.png)

데스크탑에서는 발생하지 않지만 모바일에서 버벅임이 발생하는 이유는 모바일의 하드웨어 성능이 데스크탑보다 떨어지기 때문이라고 판단했습니다. 문제를 해결하기 위해 매번 모바일로 테스트하기 힘드니, 데스크탑 크롬의 개발자 도구에서 CPU throttling을 *6x slowdown*으로 설정하고 테스트를 진행해가며 문제를 해결하였습니다.

![버벅임이 존재하는 모드 전환](https://i.imgur.com/SYMT5uj.mp4)

위 영상은 개선하기 전 블로그에서의 모드 전환 영상입니다. `transition: background-color 0.3s ease-in-out`을 적용했지만 부드러운 transition은 전혀 느낄 수 없고, 엄청난 버벅임 밖에 느껴지지 않습니다.

### 구체적인 원인 파악

![Performance 측정](https://i.imgur.com/PztRTta.png)

크롬의 개발자 도구를 이용해 Performance를 측정해보았습니다. 위쪽의 보라색 언덕과 수많은 `Animation`이 보이시나요? transition으로 인해 애니메이션 연산에 많은 CPU 리소스가 소모되고 있음을 알 수 있습니다.

![Performance monitor를 이용한 CPU 사용량 측정](https://i.imgur.com/PnC7o35.png)

크롬의 Performance monitor를 이용해 CPU 리소스가 얼마나 사용되는지 구체적으로 측정해보았습니다. **Performance monitor에서 분홍색은 레이아웃 변경에 사용되는 CPU 사용량을 나타냅니다**. 모드 전환을 할 때마다 분홍색 그래프가 치솟았는데, 이 수치가 거의 CPU 사용량 90 ~ 100%에 수렴하는 것을 확인할 수 있었습니다.

## 해결 방법

모드를 전환할 때 색상이 갑자기 바뀌면 눈에 피로감을 줄 수 있다고 생각하여 transition을 통해 부드럽게 바뀌길 원했습니다. 블로그의 여러 요소 중 글씨, 버튼과 같은 요소는 작기 때문에 피로도에 크게 영향을 미치지 않지만, 배경은 면적이 가장 넓고 항상 보이기 때문에 전환시 피로도에 큰 영향을 준다고 생각했습니다. 그래서 색상에 대한 transition은 배경색 외에는 거의 주지 않았습니다. 따라서 배경색 transition만 효율적으로 할 수 있다면 문제를 해결할 수 있을 것이라고 판단했습니다.

### 어떻게 효율적으로 할 수 있을까?

![고안한 방법](https://i.imgur.com/SGvKfhb.png)

스크롤이 길 때만 버벅임이 발생하였습니다. 이 사실과 배경색의 transition 때문에 버벅임이 발생한다는 사실을 조합하여 *배경색의 픽셀 수를 줄이면 되지 않을까?* 라는 생각이 들었고, 다음과 같은 아이디어를 떠올렸습니다.
1. 스크롤 전체에 투명배경을 적용합니다.
2. 라이트모드시 흰 색, 다크모드시 검은 색으로 배경색이 transition 되는, 스크린 크기의 div 태그를 만듭니다.
3. 2번의 div 태그를 fixed로 고정하여 사용자의 스크린을 항상 따라다니게 만듭니다.

이해되시나요? 아마 이해가 잘 되지 않아도 다음 영상을 보시면 이해가 가실 것입니다.

![해결방법을 적용한 후 Layers](https://i.imgur.com/sTolSSF.mp4)

위 영상은 해결방법을 적용하여 개선한 블로그를 크롬의 Layers를 이용해 동작을 확인한 영상입니다. 사용자의 스크린 영역만 다크모드, 라이트모드에 따라서 배경색이 바뀝니다.^[헤더는 별도로 색상을 주었습니다. 헤더에 색상을 주지 않으면 헤더와 스크롤의 내용이 겹치기 때문입니다.]

## 개선 결과

![개선된 상태에서 모드 전환](https://i.imgur.com/QIHLuiY.mp4)

실제로 CPU throttling을 *6x slowdown*으로 설정하고 전환해도 부드럽게 transition이 이루어지는 것을 확인할 수 있습니다.

![CPU 사용량 측정](https://i.imgur.com/YWNgLPT.png)

CPU 사용량 또한 기존 90 ~ 100%에서 50%로 낮아졌습니다. 약 50%의 성능 향상을 이룬 것입니다!

## 마치며

사실 원인 파악은 꽤 쉽게 했지만 해결 방법 고안은 꽤 어려웠습니다. 모드 전환간 transition이 존재하며 스크롤이 긴 사이트들을 몇몇 발견했는데 모두 다 버벅임이 존재했습니다. ^[그 중에는 많은 개발자들이 이용하는 [velog](https://velog.io/)도 있습니다. 홈 화면에서 스크롤을 아래로 내려 글을 좀 더 로드한 후에 모드를 전환하면 버벅임이 경험할 수 있습니다.] 그래서 *해결할 수 없는 것인가?* 라는 생각이 들었습니다만 계속 고민했습니다. 그리고 위에서 기술한 아이디어를 떠올리고 해결할 수 있었습니다.

이 문제를 해결하고 나서 1가지 생각과 기분이 들었습니다. 든 생각은 *이게 되네...* 하는 생각이었고, 든 기분은 뿌듯함이었습니다. 오랜 시간이 소요되긴 했지만, 문제 인식 → 원인 파악 → 해결 방법 고안 → 해결 방법 적용, 이 일련의 과정이 논리적으로 딱딱 맞아 떨어졌기 때문입니다.

동일한 문제를 겪고 계신 분께 직접적으로 도움이 되면 좋겠지만, 이 방법이 모든 경우에 적용할 수 있는 해결책이라고는 생각하지 않습니다. 직접적으로 도움이 되지는 못하더라도, 이 해결책으로부터 새로운 아이디어를 떠올려 문제를 해결할 수 있으면 좋겠네요. 🙃

